name: Repository setup
run-name: Initial setup of repository

permissions:
  contents: write
  issues: write

on:
  push:
    branches:
      - main

concurrency:
  group: repository-setup
  cancel-in-progress: true

jobs:
  repository-setup:
    name: Repository setup
    if: github.run_number == 1

    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Remove unneeded files
        run: |
          rm -f .github/workflows/repository-setup.yml
          rm -f README.md

      - name: Remove default labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh label list --json name --jq '.[].name' | xargs -I{} gh label delete "{}" --confirm --repo ${{ github.repository }}

      - name: Clone labels from template
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh label clone Vianpyro/Template --repo ${{ github.repository }} --force

      - name: Init README
        run: |
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          echo "# ${REPO_NAME}

          Welcome to the **${REPO_NAME}** repository! This repository was generated from a template to get you started quickly.

          ## ðŸš€ Getting Started

          To get started with this project:

          1. Clone the repository:
             \`\`\`bash
             git clone https://github.com/${{ github.repository }}.git
             cd ${REPO_NAME}
             \`\`\`
          2. Install any dependencies (if applicable).
          3. Follow the instructions in the relevant documentation or project files to start working.

          ## ðŸ“ Project Structure

          The repository contains the following directories and files:

          - \`.devcontainer/\` - Development container configuration for VS Code
            - \`devcontainer.json\` - Dev container settings
            - \`Dockerfile\` - Container image definition
          - \`.github/\` - GitHub-specific configurations
            - \`ISSUE_TEMPLATE/\` - Issue templates (bug reports, feature requests)
            - \`pull_request_template.md\` - Pull request template
            - \`workflows/\` - GitHub Actions workflow files
          - \`.vscode/\` - VS Code workspace settings and tasks
          - \`.dockerignore\` - Docker build exclusions
          - \`.gitattributes\` - Git attributes configuration
          - \`.gitignore\` - Git ignore patterns
          - \`README.md\` - This file

          ## ðŸ›  Features

          - Initialized from a reusable template for quick setup.
          - Pre-configured workflows for automation and CI/CD.
          - Placeholder sections for documentation, testing, and development.

          ## ðŸ“– Documentation

          Check the project files and comments for guidance. You can expand this section as your project grows.

          ## ðŸ¤ Contributing

          Contributions are welcome! Feel free to open issues, submit pull requests, or suggest improvements.

          ## ðŸ“ License

          Specify your license here (if any). For example: MIT, Apache 2.0, etc.

          Happy coding! ðŸŽ‰" > README.md

      - name: Commit changed files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'Setup repo'
          commit_user_name: Vianpyro
